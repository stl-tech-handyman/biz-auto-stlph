<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - STL Party Helpers</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/admin-shared.css" rel="stylesheet">
    <link href="/static/css/server-timer.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .stat-card {
            border-left: 4px solid #007bff;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 2rem;
        }
        .stat-badge-large {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-star-fill me-2"></i>STL Party Helpers Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/test-dashboard.html">Tests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/financial-dashboard.html">Financial</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analytics-dashboard.html">Analytics</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">Analytics Dashboard</h1>
            <p class="lead">Event statistics, trends, and insights</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Total Events</h6>
                        <h2 class="stat-badge-large text-primary" id="totalEvents">0</h2>
                        <small class="text-muted">All time</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">This Year</h6>
                        <h2 class="stat-badge-large text-success" id="eventsThisYear">0</h2>
                        <small class="text-muted" id="yearLabel">2026</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">This Month</h6>
                        <h2 class="stat-badge-large text-info" id="eventsThisMonth">0</h2>
                        <small class="text-muted" id="monthLabel">January 2026</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-muted">Avg Helpers/Event</h6>
                        <h2 class="stat-badge-large text-warning" id="avgHelpers">0</h2>
                        <small class="text-muted">Per event</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Filter Analytics</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Year</label>
                        <select id="yearFilter" class="form-select" onchange="updateAnalytics()">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Month</label>
                        <select id="monthFilter" class="form-select" onchange="updateAnalytics()">
                            <option value="all">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="updateAnalytics()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Events by Year</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="eventsByYearChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Events by Month</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="eventsByMonthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Events by Day of Week</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="eventsByDayChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Helper Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="helpersDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics Table -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Event Statistics by Year/Month</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportAnalytics()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="analyticsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Events</th>
                                <th>Total Helpers</th>
                                <th>Total Hours</th>
                                <th>Avg Helpers</th>
                                <th>Avg Hours</th>
                                <th>Special Dates</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">Loading analytics data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Year Comparison -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Year-over-Year Comparison</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="yearComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>STL Party Helpers</h5>
                    <p class="mb-0">Analytics Dashboard</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a href="/" class="text-white text-decoration-none me-3">Home</a>
                        <span class="text-muted">v1.0</span>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/server-timer.js"></script>
    <script>
        let analyticsData = [];
        let eventsByYearChart = null;
        let eventsByMonthChart = null;
        let eventsByDayChart = null;
        let helpersDistributionChart = null;
        let yearComparisonChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            document.getElementById('yearLabel').textContent = now.getFullYear();
            document.getElementById('monthLabel').textContent = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            populateYearFilter();
            loadAnalyticsData();
        });

        function populateYearFilter() {
            const select = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                select.appendChild(option);
            }
        }

        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/test/pricing-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (data.results) {
                    analyticsData = processAnalyticsData(data.results);
                    updateAnalytics();
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
                analyticsData = generateSampleAnalyticsData();
                updateAnalytics();
            }
        }

        function processAnalyticsData(testResults) {
            const processed = [];
            
            testResults.forEach(result => {
                const eventData = result.data;
                if (!eventData || !eventData.date) return;

                const eventDate = new Date(eventData.date + 'T00:00:00');
                const year = eventDate.getFullYear();
                const month = String(eventDate.getMonth() + 1).padStart(2, '0');
                const dayOfWeek = eventDate.getDay(); // 0 = Sunday, 6 = Saturday
                const numHelpers = eventData.numHelpers || 2;
                const hours = eventData.durationHours || 4;
                const isSpecialDate = eventData.isSpecialDate && eventData.rateType === 'holiday';

                processed.push({
                    date: eventData.date,
                    year: year,
                    month: month,
                    monthName: eventDate.toLocaleDateString('en-US', { month: 'long' }),
                    dayOfWeek: dayOfWeek,
                    dayName: eventDate.toLocaleDateString('en-US', { weekday: 'long' }),
                    helpers: numHelpers,
                    hours: hours,
                    isSpecialDate: isSpecialDate
                });
            });

            return processed;
        }

        function generateSampleAnalyticsData() {
            const sample = [];
            const now = new Date();
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + Math.floor(Math.random() * 365));
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dayOfWeek = date.getDay();
                const numHelpers = Math.floor(Math.random() * 3) + 2; // 2-4 helpers
                const hours = Math.random() > 0.5 ? 4 : 6;

                sample.push({
                    date: date.toISOString().split('T')[0],
                    year: year,
                    month: month,
                    monthName: date.toLocaleDateString('en-US', { month: 'long' }),
                    dayOfWeek: dayOfWeek,
                    dayName: date.toLocaleDateString('en-US', { weekday: 'long' }),
                    helpers: numHelpers,
                    hours: hours,
                    isSpecialDate: Math.random() > 0.9
                });
            }

            return sample;
        }

        function updateAnalytics() {
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;

            let filtered = analyticsData;
            if (yearFilter !== 'all') {
                filtered = filtered.filter(item => item.year === parseInt(yearFilter));
            }
            if (monthFilter !== 'all') {
                filtered = filtered.filter(item => item.month === monthFilter);
            }

            // Update summary stats
            const totalEvents = analyticsData.length;
            const thisYear = new Date().getFullYear();
            const thisMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            const eventsThisYear = analyticsData.filter(item => item.year === thisYear).length;
            const eventsThisMonth = analyticsData.filter(item => item.year === thisYear && item.month === thisMonth).length;
            const avgHelpers = analyticsData.length > 0 
                ? (analyticsData.reduce((sum, item) => sum + item.helpers, 0) / analyticsData.length).toFixed(1)
                : 0;

            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('eventsThisYear').textContent = eventsThisYear;
            document.getElementById('eventsThisMonth').textContent = eventsThisMonth;
            document.getElementById('avgHelpers').textContent = avgHelpers;

            // Update charts
            updateCharts(filtered);
            
            // Update table
            updateAnalyticsTable(filtered);
        }

        function updateCharts(data) {
            // Events by Year
            const yearGroups = {};
            data.forEach(item => {
                if (!yearGroups[item.year]) {
                    yearGroups[item.year] = 0;
                }
                yearGroups[item.year]++;
            });

            const years = Object.keys(yearGroups).sort();
            const yearCounts = years.map(y => yearGroups[y]);

            if (eventsByYearChart) eventsByYearChart.destroy();
            const ctx1 = document.getElementById('eventsByYearChart').getContext('2d');
            eventsByYearChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Events',
                        data: yearCounts,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: '#007bff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Events by Month
            const monthGroups = {};
            data.forEach(item => {
                const key = `${item.year}-${item.month}`;
                if (!monthGroups[key]) {
                    monthGroups[key] = { count: 0, label: `${item.monthName} ${item.year}` };
                }
                monthGroups[key].count++;
            });

            const monthKeys = Object.keys(monthGroups).sort();
            const monthLabels = monthKeys.map(k => monthGroups[k].label);
            const monthCounts = monthKeys.map(k => monthGroups[k].count);

            if (eventsByMonthChart) eventsByMonthChart.destroy();
            const ctx2 = document.getElementById('eventsByMonthChart').getContext('2d');
            eventsByMonthChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Events',
                        data: monthCounts,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Events by Day of Week
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayGroups = {};
            dayNames.forEach((name, index) => {
                dayGroups[index] = 0;
            });
            data.forEach(item => {
                dayGroups[item.dayOfWeek]++;
            });

            const dayCounts = dayNames.map((name, index) => dayGroups[index]);

            if (eventsByDayChart) eventsByDayChart.destroy();
            const ctx3 = document.getElementById('eventsByDayChart').getContext('2d');
            eventsByDayChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: dayNames,
                    datasets: [{
                        data: dayCounts,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Helper Distribution
            const helperGroups = {};
            data.forEach(item => {
                if (!helperGroups[item.helpers]) {
                    helperGroups[item.helpers] = 0;
                }
                helperGroups[item.helpers]++;
            });

            const helperCounts = Object.keys(helperGroups).sort().map(h => parseInt(h));
            const helperFreq = helperCounts.map(h => helperGroups[h]);

            if (helpersDistributionChart) helpersDistributionChart.destroy();
            const ctx4 = document.getElementById('helpersDistributionChart').getContext('2d');
            helpersDistributionChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: helperCounts.map(h => `${h} Helper${h > 1 ? 's' : ''}`),
                    datasets: [{
                        label: 'Events',
                        data: helperFreq,
                        backgroundColor: 'rgba(255, 193, 7, 0.7)',
                        borderColor: '#ffc107',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Year Comparison
            const allYearGroups = {};
            analyticsData.forEach(item => {
                if (!allYearGroups[item.year]) {
                    allYearGroups[item.year] = 0;
                }
                allYearGroups[item.year]++;
            });

            const allYears = Object.keys(allYearGroups).sort();
            const allYearCounts = allYears.map(y => allYearGroups[y]);

            if (yearComparisonChart) yearComparisonChart.destroy();
            const ctx5 = document.getElementById('yearComparisonChart').getContext('2d');
            yearComparisonChart = new Chart(ctx5, {
                type: 'line',
                data: {
                    labels: allYears,
                    datasets: [{
                        label: 'Total Events',
                        data: allYearCounts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateAnalyticsTable(data) {
            const tbody = document.getElementById('analyticsTableBody');
            
            // Group by year and month
            const grouped = {};
            data.forEach(item => {
                const key = `${item.year}-${item.month}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        year: item.year,
                        month: item.month,
                        monthName: item.monthName,
                        events: 0,
                        totalHelpers: 0,
                        totalHours: 0,
                        specialDates: 0
                    };
                }
                grouped[key].events++;
                grouped[key].totalHelpers += item.helpers;
                grouped[key].totalHours += item.hours;
                if (item.isSpecialDate) grouped[key].specialDates++;
            });

            const rows = Object.keys(grouped).sort().map(key => {
                const g = grouped[key];
                return {
                    ...g,
                    avgHelpers: (g.totalHelpers / g.events).toFixed(1),
                    avgHours: (g.totalHours / g.events).toFixed(1)
                };
            });

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data for selected filters</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td>${row.year}</td>
                    <td>${row.monthName}</td>
                    <td><strong>${row.events}</strong></td>
                    <td>${row.totalHelpers}</td>
                    <td>${row.totalHours}</td>
                    <td>${row.avgHelpers}</td>
                    <td>${row.avgHours}</td>
                    <td>${row.specialDates > 0 ? `<span class="badge bg-warning">${row.specialDates}</span>` : '-'}</td>
                </tr>
            `).join('');
        }

        function exportAnalytics() {
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            let filtered = analyticsData;
            if (yearFilter !== 'all') {
                filtered = filtered.filter(item => item.year === parseInt(yearFilter));
            }
            if (monthFilter !== 'all') {
                filtered = filtered.filter(item => item.month === monthFilter);
            }

            // Group by year/month for export
            const grouped = {};
            filtered.forEach(item => {
                const key = `${item.year}-${item.month}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        year: item.year,
                        month: item.month,
                        monthName: item.monthName,
                        events: 0,
                        totalHelpers: 0,
                        totalHours: 0,
                        specialDates: 0
                    };
                }
                grouped[key].events++;
                grouped[key].totalHelpers += item.helpers;
                grouped[key].totalHours += item.hours;
                if (item.isSpecialDate) grouped[key].specialDates++;
            });

            let csv = 'Year,Month,Events,Total Helpers,Total Hours,Avg Helpers,Avg Hours,Special Dates\n';
            Object.keys(grouped).sort().forEach(key => {
                const g = grouped[key];
                const avgHelpers = (g.totalHelpers / g.events).toFixed(1);
                const avgHours = (g.totalHours / g.events).toFixed(1);
                csv += `${g.year},${g.monthName},${g.events},${g.totalHelpers},${g.totalHours},${avgHelpers},${avgHours},${g.specialDates}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
