<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Analysis Dashboard</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/admin-shared.css" rel="stylesheet">
    <link href="/static/css/server-timer.css" rel="stylesheet">
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .job-badge {
            font-size: 0.85rem;
        }
        .agent-status {
            font-size: 0.8rem;
        }
        #stats-container {
            min-height: 400px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-envelope-paper me-2"></i>Email Analysis Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    
                    <!-- Dashboards -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="dashboardsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-speedometer2"></i> Dashboards
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/financial-dashboard.html">
                                <i class="bi bi-cash-stack"></i> Financial Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="/analytics-dashboard.html">
                                <i class="bi bi-graph-up-arrow"></i> Analytics Dashboard
                            </a></li>
                            <li><a class="dropdown-item active" href="/email-analysis-dashboard.html">
                                <i class="bi bi-envelope-paper"></i> Email Analysis Dashboard
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/test-dashboard.html">
                                <i class="bi bi-lightning-charge"></i> Test Dashboard
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Email Tools -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="emailDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-envelope"></i> Email Tools
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/email-template-preview.html">
                                <i class="bi bi-envelope-heart"></i> Email Template Preview
                            </a></li>
                            <li><a class="dropdown-item active" href="/email-analysis-dashboard.html">
                                <i class="bi bi-envelope-paper"></i> Email Analysis
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Quote Tools -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="quoteDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-file-text"></i> Quote Tools
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/quote-preview.html">
                                <i class="bi bi-eye"></i> Quote Preview
                            </a></li>
                            <li><a class="dropdown-item" href="/quote-test-all.html">
                                <i class="bi bi-check2-square"></i> Quote Test All
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- Features & Testing -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="featuresDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-stars"></i> Features
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/features-showcase.html">
                                <i class="bi bi-star"></i> Feature Showcase
                            </a></li>
                            <li><a class="dropdown-item" href="/pdf-feature-docs.html">
                                <i class="bi bi-file-pdf"></i> PDF Feature Docs
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- System -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="systemDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> System
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/settings.html">
                                <i class="bi bi-sliders"></i> Settings
                            </a></li>
                            <li><a class="dropdown-item" href="/api/health">
                                <i class="bi bi-heart-pulse"></i> Health Check
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/docs/internal/">
                                <i class="bi bi-book"></i> Documentation
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-5">
                    <i class="bi bi-envelope-paper"></i> Email Analysis Dashboard
                </h1>
                <p class="text-muted">Live statistics and progress tracking for email analysis jobs</p>
            </div>
        </div>

        <div id="stats-container">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Checking for active analysis...</p>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval = null;
        let currentSpreadsheetID = '';

        // Auto-detect spreadsheet on page load
        async function autoDetectSpreadsheet() {
            try {
                // First, check URL parameter (highest priority)
                const params = new URLSearchParams(window.location.search);
                const urlSpreadsheetID = params.get('spreadsheet_id');
                
                if (urlSpreadsheetID) {
                    console.log('Found spreadsheet ID in URL:', urlSpreadsheetID);
                    currentSpreadsheetID = urlSpreadsheetID;
                    // Save to localStorage for future visits
                    localStorage.setItem('emailAnalysisSpreadsheetID', urlSpreadsheetID);
                    loadStats();
                    return;
                }
                
                // Try to get from localStorage
                const saved = localStorage.getItem('emailAnalysisSpreadsheetID');
                if (saved) {
                    console.log('Found spreadsheet ID in localStorage:', saved);
                    currentSpreadsheetID = saved;
                    loadStats();
                    return;
                }
                
                // No spreadsheet found
                console.log('No spreadsheet ID found');
                showNoAnalysisMessage();
            } catch (error) {
                console.error('Failed to detect spreadsheet:', error);
                showNoAnalysisMessage();
            }
        }

        function showNoAnalysisMessage() {
            document.getElementById('stats-container').innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-file-earmark-spreadsheet" style="font-size: 4rem; color: #6c757d;"></i>
                    <h3 class="mt-3">No Active Analysis</h3>
                    <p class="text-muted">Start an email analysis job to begin processing. The spreadsheet will be created automatically.</p>
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>To start:</strong> Run the email analyzer from the command line. 
                            It will create a spreadsheet automatically and this dashboard will show the stats.
                        </div>
                    </div>
                </div>
            `;
        }

        function loadStats() {
            if (!currentSpreadsheetID) {
                showNoAnalysisMessage();
                return;
            }
            
            fetchStats();
            
            // Auto-refresh every 5 seconds
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(fetchStats, 5000);
        }

        async function fetchStats() {
            if (!currentSpreadsheetID) {
                console.log('No spreadsheet ID available');
                return;
            }
            
            try {
                console.log('Fetching stats for spreadsheet:', currentSpreadsheetID);
                const response = await fetch(`/api/email-analysis/stats?spreadsheet_id=${currentSpreadsheetID}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const stats = await response.json();
                console.log('Stats received:', stats);
                renderStats(stats);
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                const sheetUrl = currentSpreadsheetID ? `https://docs.google.com/spreadsheets/d/${currentSpreadsheetID}` : '';
                document.getElementById('stats-container').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Failed to load stats: ${error.message}
                        ${sheetUrl ? `
                            <div class="mt-3">
                                <a href="${sheetUrl}" target="_blank" class="btn btn-outline-primary">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Open Google Sheet Directly
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        function renderStats(stats) {
            const container = document.getElementById('stats-container');
            
            // Ensure arrays exist (handle null from API)
            if (!stats.jobs || !Array.isArray(stats.jobs)) stats.jobs = [];
            if (!stats.active_agents || !Array.isArray(stats.active_agents)) stats.active_agents = [];
            
            const lastUpdated = new Date(stats.last_updated);
            const lastRun = stats.last_run && stats.last_run !== '0001-01-01T00:00:00Z' ? new Date(stats.last_run) : null;
            const timeSince = lastRun ? formatTimeAgo(lastRun) : 'Never';
            
            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col">
                        <div class="card stat-card border-primary">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-envelope-check text-primary"></i> Total Processed
                                </h5>
                                <h2 class="display-4 text-primary">${formatNumber(stats.total_processed)}</h2>
                                <p class="text-muted mb-0">
                                    <small>Last run: ${timeSince}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card stat-card border-warning">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-envelope-x text-warning"></i> Total Skipped
                                </h5>
                                <h2 class="display-4 text-warning">${formatNumber(stats.total_skipped)}</h2>
                                <p class="text-muted mb-0">
                                    <small>Test/duplicate emails</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card stat-card border-info">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-fingerprint text-info"></i> Message IDs Tracked
                                </h5>
                                <h2 class="display-4 text-info">${formatNumber(stats.processed_ids_count)}</h2>
                                <p class="text-muted mb-0">
                                    <small>For resume functionality</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card stat-card border-success">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-people text-success"></i> Active Agents
                                </h5>
                                <h2 class="display-4 text-success">${(stats.active_agents && stats.active_agents.length) || 0}</h2>
                                <p class="text-muted mb-0">
                                    <small>Currently processing</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-briefcase"></i> Current Job
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Job ID:</strong> 
                                        <span class="badge bg-primary job-badge">${stats.current_job_id || 'None'}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Job Name:</strong> ${stats.current_job_name || 'No active job'}
                                    </div>
                                </div>
                                ${stats.spreadsheet_url ? `
                                    <div class="mt-3">
                                        <a href="${stats.spreadsheet_url}" target="_blank" class="btn btn-primary btn-lg">
                                            <i class="bi bi-file-earmark-spreadsheet"></i> Open Google Sheet
                                        </a>
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label"><strong>Direct Google Sheet URL:</strong></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" id="sheet-url-copy" value="${stats.spreadsheet_url}" readonly>
                                            <button class="btn btn-outline-secondary" onclick="copySheetUrl(event)" title="Copy URL">
                                                <i class="bi bi-clipboard"></i> Copy
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-2">
                                            <i class="bi bi-info-circle"></i> Contains all raw data, job stats, locks, and analysis results
                                        </small>
                                    </div>
                                ` : currentSpreadsheetID ? `
                                    <div class="mt-3">
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> 
                                            Stats loading... 
                                            <a href="https://docs.google.com/spreadsheets/d/${currentSpreadsheetID}" target="_blank" class="alert-link">Open Sheet Directly</a>
                                        </div>
                                    </div>
                                ` : '<p class="text-muted mt-2"><small>Spreadsheet URL will appear once stats are loaded</small></p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-people"></i> Active Agents
                                </h5>
                                <span class="badge bg-light text-dark">${(stats.active_agents && stats.active_agents.length) || 0}</span>
                            </div>
                            <div class="card-body">
                                ${stats.active_agents.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Agent ID</th>
                                                    <th>Created At</th>
                                                    <th>Expires At</th>
                                                    <th>Time Remaining</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${stats.active_agents.map(agent => {
                                                    const expires = new Date(agent.expires_at);
                                                    const now = new Date();
                                                    const remaining = Math.max(0, Math.floor((expires - now) / 1000));
                                                    const isExpiring = remaining < 30;
                                                    return `
                                                        <tr>
                                                            <td><code>${agent.agent_id}</code></td>
                                                            <td>${formatDateTime(new Date(agent.created_at))}</td>
                                                            <td>${formatDateTime(expires)}</td>
                                                            <td>
                                                                <span class="${isExpiring ? 'text-danger' : 'text-success'}">
                                                                    ${remaining}s ${isExpiring ? '<i class="bi bi-exclamation-triangle"></i>' : ''}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-success ${isExpiring ? 'pulse' : ''}">ACTIVE</span>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted mb-0">No active agents</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-list-check"></i> Job History
                                </h5>
                            </div>
                            <div class="card-body">
                                ${stats.jobs && Array.isArray(stats.jobs) && stats.jobs.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Job ID</th>
                                                    <th>Job Name</th>
                                                    <th>Started</th>
                                                    <th>Completed</th>
                                                    <th>Processed</th>
                                                    <th>Skipped</th>
                                                    <th>Agents</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${stats.jobs.map(job => {
                                                    const statusClass = job.status === 'COMPLETED' ? 'success' : 
                                                                      job.status === 'IN_PROGRESS' ? 'warning' : 'secondary';
                                                    return `
                                                        <tr>
                                                            <td><code>${job.job_id}</code></td>
                                                            <td>${job.job_name}</td>
                                                            <td>${formatDateTime(new Date(job.started_at))}</td>
                                                            <td>${job.completed_at ? formatDateTime(new Date(*job.completed_at)) : '-'}</td>
                                                            <td><strong>${formatNumber(job.total_processed)}</strong></td>
                                                            <td>${formatNumber(job.total_skipped)}</td>
                                                            <td>
                                                                ${job.agent_ids && job.agent_ids.length > 0 ? 
                                                                    job.agent_ids.map(id => `<span class="badge bg-info agent-status">${id}</span>`).join(' ') 
                                                                    : '-'}
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-${statusClass}">${job.status}</span>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted mb-0">No jobs recorded yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 text-center text-muted">
                        <small>
                            <i class="bi bi-arrow-clockwise"></i> Auto-refreshing every 5 seconds
                            | Last updated: ${formatDateTime(lastUpdated)}
                        </small>
                    </div>
                </div>
            `;
        }

        function formatNumber(n) {
            return n.toLocaleString();
        }

        function formatDateTime(date) {
            return date.toLocaleString();
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function copySheetUrl() {
            const input = document.getElementById('sheet-url-copy');
            if (input) {
                input.select();
                document.execCommand('copy');
                // Show feedback
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }
        }

        // Auto-detect on page load
        window.addEventListener('DOMContentLoaded', () => {
            autoDetectSpreadsheet();
        });
    </script>
    <script src="/static/js/server-timer.js"></script>
</body>
</html>
