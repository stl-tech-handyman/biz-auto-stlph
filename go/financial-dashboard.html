<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard - STL Party Helpers</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/admin-shared.css" rel="stylesheet">
    <link href="/static/css/server-timer.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .financial-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .financial-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .revenue-card { border-left-color: #28a745; }
        .payout-card { border-left-color: #dc3545; }
        .profit-card { border-left-color: #007bff; }
        .expense-card { border-left-color: #ffc107; }
        .net-profit-card { border-left-color: #6f42c1; }
        .stat-badge {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-star-fill me-2"></i>STL Party Helpers Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/test-dashboard.html">Tests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/financial-dashboard.html">Financial</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics-dashboard.html">Analytics</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">Financial Dashboard</h1>
            <p class="lead">Track revenue, contractor payouts, expenses, and profitability</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Financial Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card financial-card revenue-card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Revenue</h6>
                        <h3 class="card-title text-success" id="totalRevenue">$0.00</h3>
                        <small class="text-muted">From all events</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card financial-card payout-card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Contractor Payouts</h6>
                        <h3 class="card-title text-danger" id="totalPayouts">$0.00</h3>
                        <small class="text-muted">Base + multipliers (special dates only)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card financial-card expense-card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Expenses</h6>
                        <h3 class="card-title text-warning" id="totalExpenses">$0.00</h3>
                        <button class="btn btn-sm btn-outline-warning mt-2" onclick="showExpenseModal()">
                            <i class="bi bi-plus-circle"></i> Add Expense
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card financial-card net-profit-card h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Net Profit</h6>
                        <h3 class="card-title" id="netProfit" style="color: #6f42c1;">$0.00</h3>
                        <small class="text-muted">Revenue - Payouts - Expenses</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Filter by Date Range</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="startDate" class="form-control" onchange="updateFinancials()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" id="endDate" class="form-control" onchange="updateFinancials()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quick Filters</label>
                        <select id="quickFilter" class="form-select" onchange="applyQuickFilter()">
                            <option value="">Custom Range</option>
                            <option value="today">Today</option>
                            <option value="thisWeek">This Week</option>
                            <option value="thisMonth">This Month</option>
                            <option value="thisYear">This Year</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="lastYear">Last Year</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="updateFinancials()">
                            <i class="bi bi-arrow-clockwise"></i> Update
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Revenue vs Payouts</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenuePayoutChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Profit Margin Trend</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="profitMarginChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Breakdown Table -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Event Financial Breakdown</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportFinancials()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="financialTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Event</th>
                                <th>Helpers</th>
                                <th>Hours</th>
                                <th>Revenue</th>
                                <th>Base Payout</th>
                                <th>Multiplier</th>
                                <th>Total Payout</th>
                                <th>Profit</th>
                                <th>Margin %</th>
                            </tr>
                        </thead>
                        <tbody id="financialTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">Loading financial data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses Table -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Expenses</h5>
                <button class="btn btn-sm btn-outline-warning" onclick="showExpenseModal()">
                    <i class="bi bi-plus-circle"></i> Add Expense
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="expensesTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">No expenses recorded</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="expenseDate" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" id="expenseDescription" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select id="expenseCategory" class="form-select" required>
                                <option value="">Select category</option>
                                <option value="equipment">Equipment</option>
                                <option value="marketing">Marketing</option>
                                <option value="office">Office</option>
                                <option value="travel">Travel</option>
                                <option value="insurance">Insurance</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="expenseAmount" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveExpense()">Save Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>STL Party Helpers</h5>
                    <p class="mb-0">Financial Dashboard</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a href="/" class="text-white text-decoration-none me-3">Home</a>
                        <span class="text-muted">v1.0</span>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/server-timer.js"></script>
    <script>
        // Financial data storage
        let financialData = [];
        let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
        let revenueChart = null;
        let profitMarginChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDateRange();
            loadFinancialData();
            updateExpensesTable();
        });

        function setDefaultDateRange() {
            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            document.getElementById('startDate').value = startOfYear.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function applyQuickFilter() {
            const filter = document.getElementById('quickFilter').value;
            const today = new Date();
            let startDate, endDate;

            switch(filter) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'thisWeek':
                    const dayOfWeek = today.getDay();
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - dayOfWeek);
                    endDate = today;
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'lastYear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
                default:
                    return;
            }

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            updateFinancials();
        }

        async function loadFinancialData() {
            // For now, generate sample data based on pricing test results
            // In production, this would fetch from an API
            try {
                const response = await fetch('/api/test/pricing-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (data.results) {
                    financialData = processFinancialData(data.results);
                    updateFinancials();
                }
            } catch (error) {
                console.error('Error loading financial data:', error);
                // Use sample data for demo
                financialData = generateSampleFinancialData();
                updateFinancials();
            }
        }

        function processFinancialData(testResults) {
            const processed = [];
            const now = new Date();
            
            testResults.forEach(result => {
                const eventData = result.data;
                if (!eventData || !eventData.date) return;

                const eventDate = new Date(eventData.date + 'T00:00:00');
                const numHelpers = eventData.numHelpers || 2;
                const hours = eventData.durationHours || 4;
                const baseRate = eventData.baseRate || 300;
                const hourlyRate = eventData.hourlyRate || 50;
                const totalCost = eventData.totalCost || 600;
                
                // Calculate base payout (what we pay contractors)
                const baseBlockHours = Math.min(hours, 4);
                const extraHours = Math.max(hours - 4, 0);
                const basePayout = baseRate * numHelpers; // Base rate for first 4 hours
                const extraPayout = hourlyRate * numHelpers * extraHours;
                let totalPayout = basePayout + extraPayout;

                // Apply multiplier ONLY for special dates (holidays), NOT surge dates
                const isSpecialDate = eventData.isSpecialDate && eventData.rateType === 'holiday';
                const multiplier = isSpecialDate && eventData.specialMultiplier ? eventData.specialMultiplier : 1.0;
                
                if (multiplier > 1.0) {
                    totalPayout *= multiplier;
                }

                const profit = totalCost - totalPayout;
                const margin = totalCost > 0 ? (profit / totalCost * 100) : 0;

                processed.push({
                    date: eventData.date,
                    dateFormatted: eventData.dateMMDDYYYY || eventData.date,
                    event: eventData.label || 'Event',
                    helpers: numHelpers,
                    hours: hours,
                    revenue: totalCost,
                    basePayout: basePayout + extraPayout,
                    multiplier: multiplier,
                    totalPayout: totalPayout,
                    profit: profit,
                    margin: margin,
                    isSpecialDate: isSpecialDate,
                    specialLabel: eventData.specialLabel
                });
            });

            return processed;
        }

        function generateSampleFinancialData() {
            // Generate sample data for demonstration
            const sample = [];
            const now = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);
                const numHelpers = Math.floor(Math.random() * 3) + 2; // 2-4 helpers
                const hours = Math.random() > 0.5 ? 4 : 6;
                const baseRate = 300;
                const hourlyRate = 50;
                const basePayout = baseRate * numHelpers;
                const extraPayout = hourlyRate * numHelpers * Math.max(hours - 4, 0);
                const totalPayout = basePayout + extraPayout;
                const revenue = totalPayout * (1.3 + Math.random() * 0.2); // 30-50% markup
                const profit = revenue - totalPayout;
                const margin = (profit / revenue * 100);

                sample.push({
                    date: date.toISOString().split('T')[0],
                    dateFormatted: date.toLocaleDateString('en-US'),
                    event: `Event ${i + 1}`,
                    helpers: numHelpers,
                    hours: hours,
                    revenue: Math.round(revenue * 100) / 100,
                    basePayout: basePayout + extraPayout,
                    multiplier: 1.0,
                    totalPayout: totalPayout,
                    profit: Math.round(profit * 100) / 100,
                    margin: Math.round(margin * 100) / 100,
                    isSpecialDate: false
                });
            }

            return sample;
        }

        function updateFinancials() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const filtered = financialData.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });

            // Calculate totals
            const totalRevenue = filtered.reduce((sum, item) => sum + item.revenue, 0);
            const totalPayouts = filtered.reduce((sum, item) => sum + item.totalPayout, 0);
            const totalExpenses = expenses
                .filter(exp => exp.date >= startDate && exp.date <= endDate)
                .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
            const netProfit = totalRevenue - totalPayouts - totalExpenses;

            // Update summary cards
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalPayouts').textContent = formatCurrency(totalPayouts);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('netProfit').style.color = netProfit >= 0 ? '#28a745' : '#dc3545';

            // Update table
            updateFinancialTable(filtered);
            
            // Update charts
            updateCharts(filtered);
        }

        function updateFinancialTable(data) {
            const tbody = document.getElementById('financialTableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No data for selected date range</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.dateFormatted}</td>
                    <td>${item.event}</td>
                    <td>${item.helpers}</td>
                    <td>${item.hours}</td>
                    <td class="text-success">${formatCurrency(item.revenue)}</td>
                    <td>${formatCurrency(item.basePayout)}</td>
                    <td>${item.multiplier > 1.0 ? `<span class="badge bg-warning">${item.multiplier}x</span>` : '-'}</td>
                    <td class="text-danger">${formatCurrency(item.totalPayout)}</td>
                    <td class="${item.profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(item.profit)}</td>
                    <td class="${item.margin >= 0 ? 'text-success' : 'text-danger'}">${item.margin.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function updateCharts(data) {
            // Group by date for chart
            const grouped = {};
            data.forEach(item => {
                const date = item.date;
                if (!grouped[date]) {
                    grouped[date] = { revenue: 0, payout: 0, profit: 0 };
                }
                grouped[date].revenue += item.revenue;
                grouped[date].payout += item.totalPayout;
                grouped[date].profit += item.profit;
            });

            const dates = Object.keys(grouped).sort();
            const revenues = dates.map(d => grouped[d].revenue);
            const payouts = dates.map(d => grouped[d].payout);
            const profits = dates.map(d => grouped[d].profit);
            const margins = dates.map(d => {
                const rev = grouped[d].revenue;
                return rev > 0 ? (grouped[d].profit / rev * 100) : 0;
            });

            // Revenue vs Payouts Chart
            if (revenueChart) revenueChart.destroy();
            const ctx1 = document.getElementById('revenuePayoutChart').getContext('2d');
            revenueChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Revenue',
                        data: revenues,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Payouts',
                        data: payouts,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Profit Margin Chart
            if (profitMarginChart) profitMarginChart.destroy();
            const ctx2 = document.getElementById('profitMarginChart').getContext('2d');
            profitMarginChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Profit Margin %',
                        data: margins,
                        backgroundColor: margins.map(m => m >= 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
                        borderColor: margins.map(m => m >= 0 ? '#28a745' : '#dc3545'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showExpenseModal() {
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('expenseModal')).show();
        }

        function saveExpense() {
            const expense = {
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value)
            };

            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            updateExpensesTable();
            updateFinancials();
            
            bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No expenses recorded</td></tr>';
                return;
            }

            const sorted = expenses.sort((a, b) => b.date.localeCompare(a.date));
            tbody.innerHTML = sorted.map((exp, index) => `
                <tr>
                    <td>${exp.date}</td>
                    <td>${exp.description}</td>
                    <td><span class="badge bg-secondary">${exp.category}</span></td>
                    <td class="text-warning">${formatCurrency(exp.amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteExpense(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses.splice(index, 1);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                updateExpensesTable();
                updateFinancials();
            }
        }

        function exportFinancials() {
            // Simple CSV export
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const filtered = financialData.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });

            let csv = 'Date,Event,Helpers,Hours,Revenue,Base Payout,Multiplier,Total Payout,Profit,Margin%\n';
            filtered.forEach(item => {
                csv += `${item.dateFormatted},${item.event},${item.helpers},${item.hours},${item.revenue},${item.basePayout},${item.multiplier},${item.totalPayout},${item.profit},${item.margin}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial-report-${startDate}-to-${endDate}.csv`;
            a.click();
        }
    </script>
</body>
</html>
